# 简介
traefik 是一个现代的http反向代理,对微服务支持良好,go语言编写,维护修改方便

![image](https://docs.traefik.io/img/architecture.png)
## 优点
* 配置方式多样化,且支持热加载,配置不断更新
* 易于理解的代理模型
* 支持多种代理方式,及负载均衡算法
* 支持grpc,websocket,http/2
* 易于配置的https
* 拥有REST API,webUI
* CPU利用率较高
* 活跃的社区,文档完善
## 缺点
* 不支持fastCGI(无法直接代理php)
* 速度较慢,1.5版本约为NGINX的85%

参考:
1. [官网](https://docs.traefik.io/)
2. [Traefik Benchmarks](https://docs.traefik.io/v1.5/benchmarks/)
3. [NGINX、HAProxy和Traefik负载均衡能力对比](https://zhuanlan.zhihu.com/p/41354937)

# 安装部署
推荐使用k8s环境部署,当然也有其他部署方式,可以[官网](https://docs.traefik.io/)查看

## k8s环境部署

* rbac  角色控制 (k8s v1.6 +) //todo
traefik-rbac.yaml
```yaml
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik-ingress-controller
rules:
- apiGroups:
  - ""
  resources:
  - services
  - endpoints
  - secrets
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - extensions
  resources:
  - ingresses
  verbs:
  - get
  - list
  - watch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik-ingress-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: traefik-ingress-controller
subjects:
- kind: ServiceAccount
  name: traefik-ingress-controller
  namespace: kube-system
```

```bash
kubectl apply -f traefik-rbac.yaml
```

* ds //todo
```yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik-ingress-controller
  namespace: kube-system
---
kind: DaemonSet
apiVersion: extensions/v1beta1
metadata:
  name: traefik-ingress-controller
  namespace: kube-system
  labels:
    k8s-app: traefik-ingress-lb
spec:
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      serviceAccountName: traefik-ingress-controller
      terminationGracePeriodSeconds: 60
      containers:
      - image: traefik
        name: traefik-ingress-lb
        ports:
        - name: http
          containerPort: 80
          hostPort: 80
        - name: https
          containerPort: 443
          hostPort: 443
        - name: admin
          containerPort: 8080
        securityContext:
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE
        volumeMounts:
        - mountPath: /config
          name: config
        - mountPath: /cert
          name: cert
        args:
        - --api
        - --kubernetes
        - --logLevel=INFO
        - --configfile=/config/traefik.toml
      volumes:
      - name: config
        configMap:
          name: traefik-cfg
      - name: cert
        hostPath:
          path: /cert
          type: Directory
---
kind: Service
apiVersion: v1
metadata:
  name: traefik-ingress-service
  namespace: kube-system
spec:
  selector:
    k8s-app: traefik-ingress-lb
  ports:
  - protocol: TCP
    port: 80
    name: web
  - protocol: TCP
    port: 443
    name: https
  - protocol: TCP
    port: 8080
    targetPort: 8080
    name: admin
```

```bash
kubectl apply -f traefik-ds.yaml
```

* config //todo
```bash
kubectl apply -f traefik-config.yaml
```
* web ui
为了ui的安全性考虑,我们可以做一些安全措施,如ip限制,auth认证之类的,这里我们简单介绍一种方法,basicAuth
//todo
```bash
yum install httpd
htpasswd -c ./auth admin
kubectl create secret generic adminsecret --from-file auth --namespace=kube-system
```
traefik-ui.yaml
```yaml
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: traefik-web-ui
  namespace: kube-system
  annotations:
    kubernetes.io/ingress.class: traefik
    traefik.ingress.kubernetes.io/auth-type: "basic"
    traefik.ingress.kubernetes.io/auth-secret: "adminsecret"
spec:
  rules:
  - host: traefik-ui.niuniuniuxs.com
    http:
      paths:
      - path: /
        backend:
          serviceName: traefik-ingress-service
          servicePort: web
```

```bash
kubectl apply -f traefik-ui.yaml
```

## 如果遇到问题,怎么办
* 首先查看pod状态
```bash
kubectl get pods --all-namespaces -o wide
```
*再看日志
```bash
kubectl logs -f pods/traefik-ingress-controller-25kv6 -n kube-system
```
* 如日志不可看,像状态为pending时,使用下面命令查看原因,下面是一个之前遇到的问题的留存
```bash
[root@k8s-master my-traefik]# kubectl describe pods/traefik-ingress-controller-6545547764-2c22w -n kube-system
Name:               traefik-ingress-controller-6545547764-2c22w
Namespace:          kube-system
Priority:           0
PriorityClassName:  <none>
Node:               <none>
Labels:             k8s-app=traefik-ingress-lb
                    name=traefik-ingress-lb
                    pod-template-hash=6545547764
Annotations:        <none>
Status:             Pending
IP:
Controlled By:      ReplicaSet/traefik-ingress-controller-6545547764
Containers:
  traefik-ingress-lb:
    Image:       traefik
    Ports:       80/TCP, 8080/TCP
    Host Ports:  0/TCP, 0/TCP
    Args:
      --api
      --kubernetes
      --logLevel=INFO
    Environment:  <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from traefik-ingress-controller-token-67hr2 (ro)
Conditions:
  Type           Status
  PodScheduled   False
Volumes:
  traefik-ingress-controller-token-67hr2:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  traefik-ingress-controller-token-67hr2
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  <none>
Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
                 node.kubernetes.io/unreachable:NoExecute for 300s
Events:
  Type     Reason            Age                   From               Message
  ----     ------            ----                  ----               -------
  Warning  FailedScheduling  92s (x32 over 6m38s)  default-scheduler  0/1 nodes are available: 1 node(s) had taints that the pod didn't tolerate.
```
这个问题是要分配的k8s节点不可用,可以很直观的看到问题所在
